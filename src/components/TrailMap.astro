---
/**
 * TrailMap Component
 * 
 * Displays an interactive map with GPS track overlay for trail pages.
 * Uses Leaflet to render the map and GPX track.
 * 
 * Props:
 * @param {string} gpxFile - Path to GPX file (optional)
 * @param {number} trailNumber - Trail number for fallback display
 * @param {string} trailTitle - Trail title for display
 * @param {string} startPoint - Starting point name
 * @param {string} endPoint - Ending point name
 * @param {string} class - Additional CSS classes
 */

export interface Props {
  gpxFile?: string;
  trailNumber: number;
  trailTitle: string;
  startPoint?: string;
  endPoint?: string;
  class?: string;
}

const { gpxFile, trailNumber, trailTitle, startPoint, endPoint, class: className } = Astro.props;

// Generate unique map ID to avoid conflicts
const mapId = `trail-map-${trailNumber}`;
const gpxUrl = gpxFile ? `${import.meta.env.BASE_URL}gpx/${gpxFile}` : null;
---

<div class:list={["trail-map-container", className]}>
  <div id={mapId} class="trail-map w-full h-[400px] rounded-xl shadow-lg overflow-hidden"></div>
  {!gpxFile && (
    <div class="trail-map-placeholder text-center text-muted mt-4 text-sm">
      <p>{trailTitle} - Mappa del percorso disponibile a breve</p>
    </div>
  )}
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Leaflet JS -->
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script is:inline define:vars={{ mapId, gpxUrl, trailTitle, startPoint, endPoint }}>
  document.addEventListener('DOMContentLoaded', function() {
    const mapElement = document.getElementById(mapId);
    if (!mapElement) return;

    // Default center for Sibillini Mountains area
    const defaultCenter = [42.8, 13.2];
    const defaultZoom = 11;

    // Initialize map
    const map = L.map(mapId, {
      scrollWheelZoom: false,
      touchZoom: true,
    }).setView(defaultCenter, defaultZoom);

    // Enable scroll zoom only with CTRL key
    map.on('wheel', function(e) {
      if (e.originalEvent.ctrlKey) {
        e.originalEvent.preventDefault();
        map.scrollWheelZoom.enable();
      } else {
        map.scrollWheelZoom.disable();
      }
    });

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);

    // Function to parse GPX and draw track
    async function loadGPXTrack() {
      if (!gpxUrl) {
        // No GPX file, show default area
        return;
      }

      try {
        const response = await fetch(gpxUrl);
        if (!response.ok) {
          console.warn('GPX file not found:', gpxUrl);
          return;
        }

        const gpxText = await response.text();
        const parser = new DOMParser();
        const gpxDoc = parser.parseFromString(gpxText, 'text/xml');

        // Check for parsing errors
        const parseError = gpxDoc.querySelector('parsererror');
        if (parseError) {
          console.error('GPX parsing error:', parseError.textContent);
          return;
        }

        // Extract track points
        const trackPoints = [];
        const trkpts = gpxDoc.querySelectorAll('trkpt');

        trkpts.forEach((trkpt) => {
          const lat = parseFloat(trkpt.getAttribute('lat') || '0');
          const lng = parseFloat(trkpt.getAttribute('lon') || '0');
          if (lat && lng) {
            trackPoints.push([lat, lng]);
          }
        });

        if (trackPoints.length === 0) {
          console.warn('No track points found in GPX file');
          return;
        }

        // Draw track polyline
        const trackColor = getComputedStyle(document.documentElement)
          .getPropertyValue('--color-primary-600') || '#8B4513';
        
        const polyline = L.polyline(trackPoints, {
          color: trackColor,
          weight: 5,
          opacity: 0.8,
          smoothFactor: 1
        }).addTo(map);

        // Fit map to track bounds
        const bounds = polyline.getBounds();
        map.fitBounds(bounds, { padding: [20, 20] });

        // Add start marker
        if (trackPoints.length > 0 && startPoint) {
          const startIcon = L.divIcon({
            className: 'trail-marker trail-marker-start',
            html: `<div class="w-8 h-8 -mt-8 -ml-4"><svg viewBox="0 0 24 24" fill="#10b981" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="white"/></svg></div>`,
            iconSize: [32, 32]
          });

          L.marker(trackPoints[0], { icon: startIcon })
            .addTo(map)
            .bindPopup(`<div class="font-sans"><strong>${startPoint}</strong></div>`);
        }

        // Add end marker
        if (trackPoints.length > 1 && endPoint) {
          const endIcon = L.divIcon({
            className: 'trail-marker trail-marker-end',
            html: `<div class="w-8 h-8 -mt-8 -ml-4"><svg viewBox="0 0 24 24" fill="#ef4444" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="white"/></svg></div>`,
            iconSize: [32, 32]
          });

          L.marker(trackPoints[trackPoints.length - 1], { icon: endIcon })
            .addTo(map)
            .bindPopup(`<div class="font-sans"><strong>${endPoint}</strong></div>`);
        }

      } catch (error) {
        console.error('Error loading GPX track:', error);
      }
    }

    // Load GPX track
    loadGPXTrack();
  });
</script>

<style>
  .trail-map-container {
    position: relative;
  }

  .trail-map {
    background-color: var(--color-surface-100, #f3f4f6);
    min-height: 400px;
  }

  /* Dark mode support for Leaflet */
  :global(.dark) .trail-map {
    background-color: var(--color-surface-800, #1f2937);
  }

  /* Leaflet popup styling */
  :global(.leaflet-popup-content-wrapper) {
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  :global(.leaflet-popup-content) {
    margin: 0.75rem;
    font-family: system-ui, -apple-system, sans-serif;
  }

  .trail-map-placeholder {
    padding: 1rem;
  }
</style>
