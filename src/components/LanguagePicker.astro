---
import { languages } from "../i18n/languages";
import { getRelativeLocaleUrl } from "astro:i18n";
import { getResourceRoute } from "../utils/path";

const { lang: currentLang } = Astro.params; // current selected language in the URL
const baseUrl = import.meta.env.BASE_URL; // base path of the site

/* current resource user is navigating to */
const resourceRoute = getResourceRoute(Astro.url.pathname || "");
---

<div class="language-picker">
  <button
    id="language-picker-button"
    type="button"
    class="language-button"
    aria-label="Select language"
    aria-expanded="false"
  >
    <span class="current-lang">
      {languages[currentLang as keyof typeof languages]?.flag}
      <span class="current-lang-label">
        {languages[currentLang as keyof typeof languages]?.label}
      </span>
    </span>
    <svg
      id="language-chevron"
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="chevron"
    >
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div id="language-picker-menu" class="language-menu hidden">
    <ul class="language-list">
      {
        Object.entries(languages).map(([langKey, langObj]) => (
          <li>
            <a
              href={getRelativeLocaleUrl(langKey, resourceRoute)}
              class:list={[
                "language-option",
                { active: langKey === currentLang },
              ]}
            >
              <span class="language-flag">{langObj.flag}</span>
              <span class="language-label">{langObj.label}</span>
              {langKey === currentLang && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="check-icon"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              )}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<style>
  .language-picker {
    position: relative;
    display: inline-flex;
    align-items: center;
  }

  .language-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background-color: var(--color-primary-700);
    border: 2px solid var(--color-primary-800);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    color: white;
    font-size: 0.9375rem;
  }

  .language-button:hover {
    background-color: var(--color-primary-800);
  }

  .language-button:focus {
    outline: 2px solid var(--color-gold-400);
    outline-offset: 2px;
  }

  .current-lang {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .current-lang-label {
    display: none;
  }

  @media (min-width: 640px) {
    .current-lang-label {
      display: inline;
    }
  }

  .chevron {
    transition: transform var(--transition-fast);
  }

  .language-button[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .language-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    min-width: max(11rem, 100%);
    width: max-content;
    background-color: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    z-index: 50;
    overflow: hidden;
  }

  .language-list {
    list-style: none;
    margin: 0;
    padding: 0.5rem;
  }

  .language-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0.875rem;
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
    font-size: 0.9375rem;
  }

  .language-option:hover {
    background-color: var(--color-surface-hover);
  }

  .language-option.active {
    background-color: var(--color-primary-300);
    color: var(--color-primary-700);
    font-weight: 600;
    border-left: 3px solid var(--color-primary-600);
    padding-left: calc(0.875rem - 3px);
  }

  .language-flag {
    font-size: 1.25rem;
  }

  .language-label {
    flex: 1;
  }

  .check-icon {
    color: var(--color-accent-600);
  }

  .hidden {
    display: none;
  }
</style>

<script>
  /**
   * Language picker dropdown script
   */
  function initLanguagePicker() {
    const button = document.getElementById("language-picker-button");
    const menu = document.getElementById("language-picker-menu");

    if (!button || !menu) return;

    // Toggle menu
    button.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = button.getAttribute("aria-expanded") === "true";
      button.setAttribute("aria-expanded", String(!isExpanded));
      menu.classList.toggle("hidden");
    });

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
      if (!button.contains(e.target as Node) && !menu.contains(e.target as Node)) {
        button.setAttribute("aria-expanded", "false");
        menu.classList.add("hidden");
      }
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && button.getAttribute("aria-expanded") === "true") {
        button.setAttribute("aria-expanded", "false");
        menu.classList.add("hidden");
        button.focus();
      }
    });
  }

  // Initialize on page load
  initLanguagePicker();

  // Re-initialize on navigation (for SPAs)
  document.addEventListener("astro:after-swap", initLanguagePicker);
</script>

