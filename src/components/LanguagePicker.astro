---
import { languages } from "../i18n/languages";
import { getRelativeLocaleUrl } from "astro:i18n";
import { getResourceRoute } from "../utils/path";

const { lang: currentLang } = Astro.params; // current selected language in the URL
const baseUrl = import.meta.env.BASE_URL; // base path of the site

/* current resource user is navigating to */
const resourceRoute = getResourceRoute(Astro.url.pathname || "");
---

<div class="language-picker relative inline-flex items-center">
  <button
    type="button"
    class="language-button inline-flex items-center gap-2 px-3 py-2 bg-[var(--color-primary-700)] border-2 border-[var(--color-primary-800)] rounded-md cursor-pointer transition-all text-white text-[0.9375rem] hover:bg-[var(--color-primary-800)]"
    aria-label="Select language"
    aria-expanded="false"
  >
    <span class="flex items-center gap-2">
      {languages[currentLang as keyof typeof languages]?.flag}
      <span class="hidden sm:inline">
        {languages[currentLang as keyof typeof languages]?.label}
      </span>
    </span>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="chevron transition-transform duration-200"
    >
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div class="language-menu hidden absolute top-[calc(100%+0.5rem)] left-1/2 -translate-x-1/2 min-w-[max(11rem,100%)] w-max bg-[var(--color-surface)] border-2 border-[var(--color-border)] rounded-lg shadow-md z-50 overflow-hidden">
    <ul class="list-none m-0 p-2">
      {
        Object.entries(languages).map(([langKey, langObj]) => (
          <li>
            <a
              href={getRelativeLocaleUrl(langKey, resourceRoute)}
              class:list={[
                "flex items-center gap-3 px-3.5 py-3 text-[var(--color-text)] no-underline transition-all text-[0.9375rem] hover:bg-[var(--color-surface-hover)]",
                langKey === currentLang && "bg-[var(--color-primary-300)] text-[var(--color-primary-700)] font-semibold border-l-[3px] border-[var(--color-primary-600)] pl-[calc(0.875rem-3px)]"
              ]}
            >
              <span class="text-xl">{langObj.flag}</span>
              <span class="flex-1">{langObj.label}</span>
              {langKey === currentLang && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-[var(--color-accent-600)]"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              )}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<style>
  .language-button[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }
</style>

<script>
  /**
   * Language picker dropdown script
   * Supports multiple instances on the same page (desktop and mobile)
   */
  function initLanguagePicker() {
    const pickers = document.querySelectorAll(".language-picker");

    pickers.forEach((picker) => {
      const button = picker.querySelector(".language-button") as HTMLButtonElement;
      const menu = picker.querySelector(".language-menu") as HTMLElement;

      if (!button || !menu) return;

      // Remove existing listeners to prevent duplicates
      const newButton = button.cloneNode(true) as HTMLButtonElement;
      button.replaceWith(newButton);

      // Toggle menu
      newButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isExpanded = newButton.getAttribute("aria-expanded") === "true";
        
        // Close all other language pickers first
        document.querySelectorAll(".language-picker").forEach((otherPicker) => {
          if (otherPicker !== picker) {
            const otherButton = otherPicker.querySelector(".language-button") as HTMLButtonElement;
            const otherMenu = otherPicker.querySelector(".language-menu") as HTMLElement;
            if (otherButton && otherMenu) {
              otherButton.setAttribute("aria-expanded", "false");
              otherMenu.classList.add("hidden");
            }
          }
        });

        // Toggle current picker
        newButton.setAttribute("aria-expanded", String(!isExpanded));
        menu.classList.toggle("hidden");
      });
    });

    // Close menu when clicking outside
    const handleOutsideClick = (e: Event) => {
      document.querySelectorAll(".language-picker").forEach((picker) => {
        const button = picker.querySelector(".language-button") as HTMLButtonElement;
        const menu = picker.querySelector(".language-menu") as HTMLElement;
        
        if (button && menu && !picker.contains(e.target as Node)) {
          button.setAttribute("aria-expanded", "false");
          menu.classList.add("hidden");
        }
      });
    };

    // Remove old listener and add new one
    document.removeEventListener("click", handleOutsideClick);
    document.addEventListener("click", handleOutsideClick);

    // Close menu on escape key
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        document.querySelectorAll(".language-picker").forEach((picker) => {
          const button = picker.querySelector(".language-button") as HTMLButtonElement;
          const menu = picker.querySelector(".language-menu") as HTMLElement;
          
          if (button && menu && button.getAttribute("aria-expanded") === "true") {
            button.setAttribute("aria-expanded", "false");
            menu.classList.add("hidden");
            button.focus();
          }
        });
      }
    };

    document.removeEventListener("keydown", handleEscape);
    document.addEventListener("keydown", handleEscape);
  }

  // Initialize on page load
  initLanguagePicker();

  // Re-initialize on navigation (for SPAs)
  document.addEventListener("astro:after-swap", initLanguagePicker);
</script>

