---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../../layouts/Base.astro";
import Navigation from "../../../components/Navigation.astro";
import { useTranslations } from "../../../i18n/utils";
import { getRelativeLocaleUrl } from "astro:i18n";
import { languages } from "../../../i18n/languages";
import { toWebP } from "../../../utils/image";

export async function getStaticPaths() {
  const pages = await getCollection("saints");

  const paths = pages.map((page) => {
    const [lang, ...slug] = page.id.split("/");
    return {
      params: {
        lang,
        slug: slug.join("/") || undefined,
      },
      props: page,
    };
  });

  return paths;
}

const { lang, slug } = Astro.params;
const page = Astro.props;
const { Content } = await render(page);
const t = useTranslations(lang as keyof typeof languages);

// Get all saints for navigation
const allSaints = await getCollection("saints", ({ id }) => {
  return id.startsWith(`${lang}/`);
});
const sortedSaints = allSaints.sort((a, b) => a.data.order - b.data.order);

// Find previous and next saints
const currentIndex = sortedSaints.findIndex((saint) => saint.id === page.id);
const previousSaint = currentIndex > 0 ? sortedSaints[currentIndex - 1] : null;
const nextSaint = currentIndex < sortedSaints.length - 1 ? sortedSaints[currentIndex + 1] : null;

// SEO metadata
const pageTitle = `${page.data.name} - ${page.data.church} | Via dei Sette Santi`;
const pageDescription = page.data.description || `${page.data.name} at ${page.data.church}, ${page.data.location}.`;

// Generate image path
const imagePath = page.data.image ? `${import.meta.env.BASE_URL}images/saints/${page.data.image}` : undefined;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  ogImage={imagePath}
  ogType="article"
  preloadImage={imagePath}
>
  <!-- Hero Section with Image -->
  {imagePath && (
    <section class="relative h-96 overflow-hidden">
      <picture>
        <source 
          srcset={toWebP(imagePath)} 
          type="image/webp" 
        />
        <img
          src={imagePath}
          alt={page.data.church}
          class="w-full h-full object-cover"
          loading="eager"
          decoding="async"
          width="600"
          height="800"
        />
      </picture>
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
      <div class="absolute bottom-0 left-0 right-0 container-custom py-8 px-4">
        <div class="flex items-center gap-4 mb-4">
          <span class="bg-primary-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-3xl font-bold shadow-lg">
            {page.data.order}
          </span>
          <div>
            <p class="text-white/90 text-sm font-medium uppercase tracking-wide mb-1">
              {page.data.name}
            </p>
            <h1 class="text-4xl md:text-5xl font-bold text-white m-0">{page.data.church}</h1>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Main Content -->
  <article class="section">
    <div class="container-custom">
      <!-- Description & Details - 2 Column Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
        <!-- Left Column: Description and Content -->
        <div class="lg:col-span-2">
          <!-- Description -->
          <p class="text-xl text-muted leading-relaxed mb-8">{page.data.description}</p>
          
          <!-- Historical and Cultural Information -->
          <div class="prose prose-lg max-w-none dark:prose-invert mb-8">
            <Content />
          </div>

          <!-- History Section -->
          {page.data.history && (
            <div class="mb-8">
              <h3 class="text-2xl font-bold mb-4">{t('saint.history')}</h3>
              <p class="text-lg leading-relaxed text-muted">{page.data.history}</p>
            </div>
          )}
        </div>

        <!-- Right Column: Church Details (Sticky) -->
        <div class="lg:col-span-1">
          <div class="info-box sticky top-24">
            <h3 class="text-xl font-bold mb-6">{t('saint.details')}</h3>
            
            <div class="space-y-4">
              <div class="info-item">
                <div class="flex items-center gap-2 mb-1">
                  <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  <strong class="info-item-label">{t('saint.location')}</strong>
                </div>
                <span class="info-item-value">{page.data.location}</span>
              </div>

              {page.data.feastDay && (
                <div class="info-item">
                  <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <strong class="info-item-label">{t('saint.feastDay')}</strong>
                  </div>
                  <span class="info-item-value">{page.data.feastDay}</span>
                </div>
              )}

              <!-- Visit Church Button -->
              <div class="pt-4 border-t border-surface-200 dark:border-surface-700">
                <a
                  href="#map"
                  class="flex items-center justify-center gap-2 px-4 py-3 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-colors shadow-md hover:shadow-lg w-full"
                  aria-label={t('saint.visitChurch')}
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  {t('saint.visitChurch')}
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Section - Full Width -->
      <div class="mb-16" id="map">
        <h2 class="text-2xl font-bold mb-6">{t('saint.map')}</h2>
        <div class="info-box bg-surface-100 dark:bg-surface-800 aspect-video flex items-center justify-center rounded-xl overflow-hidden">
          {page.data.coordinates ? (
            <div class="w-full h-full flex flex-col items-center justify-center text-center p-8">
              <svg class="w-16 h-16 mx-auto mb-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <p class="text-lg font-medium mb-2">{page.data.church}</p>
              <p class="text-sm text-muted mb-4">
                {t('saint.location')}: {page.data.location}
              </p>
              <p class="text-xs text-muted font-mono">
                Lat: {page.data.coordinates.lat.toFixed(4)}, Lng: {page.data.coordinates.lng.toFixed(4)}
              </p>
              <p class="text-sm text-muted mt-4">Interactive map - Coming Soon</p>
            </div>
          ) : (
            <div class="text-center text-muted">
              <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
              </svg>
              <p class="text-sm">{t('saint.map')} - Coming Soon</p>
            </div>
          )}
        </div>
      </div>

      <!-- Saints Navigation -->
      <Navigation
        lang={lang}
        type="saints"
        previous={previousSaint}
        next={nextSaint}
        homeUrl={getRelativeLocaleUrl(lang, '')}
      />
    </div>
  </article>
</BaseLayout>

<style>
  /* Typography for prose content */
  .prose {
    color: var(--color-text);
  }

  .prose h2 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--color-heading);
    font-size: 1.75rem;
    font-weight: 700;
  }

  .prose h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-heading);
    font-size: 1.5rem;
    font-weight: 600;
  }

  .prose p {
    margin-bottom: 1rem;
    line-height: 1.75;
  }

  .prose ul,
  .prose ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  .prose strong {
    color: var(--color-heading);
    font-weight: 600;
  }

  .prose a {
    color: var(--color-primary-600);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--color-primary-700);
  }

  /* Sticky sidebar on larger screens */
  @media (min-width: 1024px) {
    .sticky {
      position: sticky;
      top: 6rem;
      align-self: start;
    }
  }
</style>
